# 初めにお読みください

## このドキュメントについて

このドキュメントは、生成AIのチャットスレッドが新しくなってもスムーズに引き継ぎできるよう、プロジェクトの基本情報と引き継ぎに必要な情報が記載されています。

このドキュメントを受け取ったあなたは、このドキュメント内の情報を確認し、チャットを送るようにしてください。また、ユーザから新たな依頼や「必ずこうして欲しい」など、今後も守るべき情報を受け取った場合はこのドキュメントの中に追記してください。

### このドキュメントを編集する際は

あなたがこのドキュメントを編集する際、ユーザには生のマークダウンデータとして提供する必要があります。
つまり、このドキュメントの最も上と最も下に、8つ以上の「`」で囲み、大きなコードブロックとして提供してください。

## プロジェクトについて

プロジェクト名: `Mocolamma`\
プロジェクトのバンドル識別子: `design.taikun.Mocolamma`

このプロジェクトは、Ollama APIを使ってOllamaの様々な管理を行うmacOS用のSwiftアプリケーションです。\
名前の由来は「**Mo**del」「**Co**ntrol」「Ol**lam**a」「**Ma**nage」を組み合わせた造語です。

### プロジェクトの構造

```
Mocolamma
├── AddModelsSheet.swift
├── ChatView.swift
├── CommandExecutor.swift
├── ContentView.swift
├── ModelListView.swift
├── MocolammaApp.swift
├── ModelDetailsView.swift
├── OllamaModel.swift
├── ServerInfo.swift
├── ServerManager.swift
├── ServerFormView.swift
├── ServerRowView.swift
├── SettingsView.swift
└── ServerView.swift
```

新たなファイルを作成した場合はこの構造に新たなファイルを追加してください。

### 各コードの役割

新たなファイルが作成された場合や機能に変更があった場合は以下の文章を変更・追加してください。コードの変更履歴を記載するものではありません。コードの役割のみを説明する必要があります。

#### `ChatView.swift`

Ollamaモデルとのチャットインターフェースを提供するビューです。モデル選択はポップオーバーで行われ、メッセージには受信日時とパフォーマンス情報が表示されます。ストリーミングレスポンスに対応しています。

#### `AddModelsSheet.swift`

新しいモデルの追加（プル）を行うためのシートビューです。ユーザーがモデル名を入力し、ダウンロードを開始するためのUIを提供します。

#### `CommandExecutor.swift`

Ollama APIへのリクエスト送信（モデルリスト取得、モデルのプル/ダウンロード、モデルの削除）と、そのレスポンス処理（ストリーミングデータを含む）を行うための中心的なロジックが実装されています。UIとは独立してAPI通信とデータ管理を行います。

#### `ContentView.swift`

アプリのメインウィンドウを構成するSwiftUIビューです。`NavigationSplitView`を使用して、サイドバー（「Categories」）、中央のコンテンツエリアを構築し、右側の詳細表示には`inspector`モディファイアを使用します。アプリ全体の状態（選択されたモデル、シート、アラートなど、および`inspector`の表示状態）を管理し、下位ビューにバインディングとして渡します。このファイルは、サイドバーのビュー切り替えと、トップレベルの状態管理に特化しています。

#### `ModelListView.swift`

モデルのテーブル表示、ダウンロード進捗ゲージ、APIログ表示、および再読み込み・モデル追加用のツールバーボタンなど、モデルリストに関連するUIとロジックをカプセル化したビューです。`ContentView`から必要なデータとバインディングを受け取って表示を更新します。

#### `MocolammaApp.swift`

SwiftUIアプリケーションの起動ポイントとなる基本ファイルです。ウィンドウのタイトルやスタイルなどの初期設定を行います。アプリケーションメニューから設定ウィンドウを開く機能が追加されました。

#### `OllamaModel.swift`

Ollama APIから取得したモデル情報（`OllamaModel`）やその詳細（`OllamaModelDetails`）、APIレスポンスのルート構造（`OllamaAPIModelsResponse`, `OllamaPullResponse`）を定義するデータモデルファイルです。データのデコード（`Codable`）やテーブル表示用のヘルパープロパティも含まれます。

#### `ServerInfo.swift`

Ollamaサーバーの接続情報を表すデータモデルです。名前とホストURLを保持し、リスト表示やUserDefaultsへの永続化に利用されます。デフォルトのローカルサーバーには`defaultServerID`という固定IDが割り当てられます。

#### `ServerManager.swift`

アプリケーション内でOllamaサーバーのリストと現在の選択状態を管理するクラスです。サーバー情報はUserDefaultsに永続化され、`currentServerHost`プロパティを通じて選択されているサーバーのホストURLを提供します。アプリ起動時にデフォルトのローカルサーバーが重複して追加されないように、固定ID(`ServerInfo.defaultServerID`)を使用して管理され、ユーザーが一度削除した場合は次回起動時に再追加されません。

#### `ServerFormView.swift`

新しいOllamaサーバーの追加、または既存サーバーの編集を行うためのシートビューです。サーバー名とホストURLの入力欄を提供し、保存時に接続確認を行います。接続エラーが発生した場合でも、「Add Anyway」または「Update Anyway」ボタンで強制的にサーバーを追加/更新できます。接続エラーメッセージはString Catalogを使用してローカライズされます。

#### `ServerRowView.swift`

サーバーリストの個々の行を表すSwiftUIビューです。サーバー名、ホスト、アイコン、および選択を示すチェックマークを表示します。

#### `SettingsView.swift`

アプリケーションの「設定」ウィンドウのメインUIを定義するSwiftUIビューです。

#### `ServerView.swift`

アプリケーションのメインサイドバーからアクセスされるサーバーコンテンツのUIを定義するSwiftUIビューです。サーバーリストの表示、デフォルトの「ローカル」サーバーの管理、新しいサーバーを追加するためのシート表示機能が追加されました。

#### `ServerInspectorView.swift`

選択されたOllamaサーバーの詳細情報を表示するSwiftUIビューです。コンテンツがウインドウの高さを超えた場合にスクロールできるように、`ScrollView`で囲まれています。

#### `ModelDetailsView.swift`

選択されたOllamaモデルの詳細情報を表示するSwiftUIビューです。コンテンツがウインドウの高さを超えた場合にスクロールできるように、`ScrollView`で囲まれています。

### 開発方針について

ここには開発を行うに当たって可能な限り守るべきことを記載します。ユーザから今後も守るべき新たな情報を受け取った場合はこのドキュメントの中に追記してください。

* ユーザは日本語で応対することを望んでいるため、必ず日本語で会話すること
* 可能な限りSwiftのベストプラクティスに沿うこと
* コード内のコメントは日本語で記載すること
* プロジェクトのターゲットはmacOS 14.0以降であるため、それ以降のバージョンで対応していないレガシーなコードは書かないこと
    * つまり、可能な限り新しいコードを書いておけば問題ありません。
* Canvasを使ってコードを提供する場合、過去のファイルを編集するのではなく、新しいファイルとして提供すること
    * 現在のGoogle Geminiでは、過去のファイルを編集した場合、過去のチャット履歴にさかのぼらなければ編集されたファイルを開くことができないため、ユーザが不便です。新しいファイルとして提供することで、常に最新のチャット履歴にコードを開くボタンが表示されるため、ユーザが快適に開発を進めることができます。
* ローカライズはString Catalogを使って行うため、エラーメッセージなどはローカライズ対応で記述すること
    * String Catalogでは、`Text('サンプルテキスト')`のようなテキストでは自動的にテキスト自体がキーとして認識されるため、この場合はローカライズ対応記述方法を使う必要はありません。
* **デバッグログのローカライズについて**:
    * `print()`文で出力されるデバッグログやコンソール出力は、ローカライズする必要はありません。
    * デバッグログは日本語で記述し、開発者が理解しやすいように可読性を優先してください。
    * ユーザー向けのUIテキストのみをローカライズ対象とし、デバッグ出力は分離して考えてください。
* 応対するたびに随時このドキュメントを読み込み、編集すること
* コードファイルの先頭にファイル名を示すコメント（例: `// FileName.swift`）は不要なため、削除すること
* SwiftUIのプレビューには、新しい`#Preview`マクロを使用すること。
* コードは、変更があったファイルのみを提供すること。
* UIに表示されるテキストと、そのローカライズキーは英語で書くこと。
* メインアクター上でのUI更新など、非同期処理を行う場合は、`DispatchQueue.main.async { ... }`の代わりに`Task { @MainActor in ... }`を使用してください。
* **Listアイテムの選択挙動について**:
    * SwiftUIの`List`において、UI上のハイライト選択（ユーザーがクリックした行を視覚的にハイライトする機能）と、API通信で使用する「現在選択されているサーバー」を区別して管理する場合がある。
    * UI上のハイライト選択には`List`の`selection`バインディングを使用し、独立した`@State`プロパティにバインドすること。
    * API通信に使用する「現在選択されているサーバー」は、`@ObservedObject`または`@StateObject`として管理されるデータモデル（例: `ServerManager`の`selectedServerID`）で保持すること。
    * リストの項目がフォーカスされている状態でEnterキーを押す、または項目をダブルクリックした際に特定のカスタムアクション（例: API通信用サーバーの切り替え）を実行するには、`contextMenu(forSelectionType:menu:primaryAction:)`モディファイアの`primaryAction`引数を使用すること。この際、UI上のハイライト選択（`listSelection`）とAPI通信用選択（`serverManager.selectedServerID`）の両方を更新することが推奨される。

### TODOリスト

ここには、今後開発をする上で一時的に保留にしている作業を記載します。

例えば、ユーザが「実際の機能は後で実装するので、とりあえず設定にオプションだけ追加してください」のような言った場合、このリストに「〇〇のオプションを追加したため、この後、実際の機能を実装する」のような項目を追加します。どのような機能を実装するのか、このドキュメントを見た誰もが理解できるように詳細に記載する必要があります。

作業が完了して実装が終わったら、実装が完了した項目をこのリストから削除してください。

* **2025/07/25**: 「設定」タブの基本的なUI構造を作成したため、今後は設定項目（例: Ollama APIのホストURL設定、ダークモード/ライトモード切り替えなど）を実装する。
* **2025/07/25**: メインサイドバーに「サーバー」タブの基本的なUI構造を作成したため、今後はメインコンテンツとしてのサーバー関連機能（例: Ollamaサーバーの起動/停止、ステータス表示など）を実装する。

## その他の情報

引き継ぎにあたって、上記以外で他に伝えるべき情報がある場合はこちらに記載してください。

* ビルドコマンド: `xcodebuild -project /Users/taikun/Documents/Xcode/Mocolamma/Mocolamma/Mocolamma.xcodeproj -scheme Mocolamma build`
